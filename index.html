<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Scanner</title>
    <style>
        :root {
            --color-primary: #2180a1;
            --color-primary-hover: #1d7490;
            --color-primary-active: #1a6873;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-bg: #fcfcf9;
            --color-surface: #ffffff;
            --color-border: #5e5240;
            --color-success: #32b8c6;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
            --color-info: #626c71;
            --focus-ring: 0 0 0 3px rgba(33, 128, 141, 0.4);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            font-family: var(--font-family);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-bg);
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            text-align: center;
            padding: 16px 0;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: 24px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
        }

        .subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .section {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all 250ms cubic-bezier(0.16, 1, 0.3, 1);
            border: none;
            text-decoration: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .btn--primary {
            background: var(--color-primary);
            color: #fcfcf9;
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--primary:active {
            background: var(--color-primary-active);
        }

        .btn--secondary {
            background: rgba(94, 82, 64, 0.12);
            color: var(--color-text);
            border: 1px solid rgba(94, 82, 64, 0.2);
        }

        .btn--secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        .btn--outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn--outline:hover {
            background: rgba(94, 82, 64, 0.12);
        }

        .btn--sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn--full-width {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        #camera {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            background: #000;
            display: none;
            margin-bottom: 12px;
        }

        #preview {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 12px;
            max-height: 300px;
            object-fit: contain;
            display: none;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: rgba(33, 128, 141, 0.08);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(33, 128, 141, 0.3);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result {
            background: rgba(33, 128, 141, 0.08);
            border: 1px solid var(--color-success);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0 0 12px 0;
        }

        .result-field {
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.6;
        }

        .result-label {
            font-weight: 600;
            color: var(--color-text);
            display: block;
            margin-bottom: 2px;
        }

        .result-value {
            color: var(--color-text-secondary);
        }

        .error-message {
            background: rgba(192, 21, 47, 0.08);
            border: 1px solid var(--color-error);
            border-radius: 8px;
            padding: 12px;
            color: var(--color-error);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .error-message.show {
            display: block;
        }

        .medicine-db {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(94, 82, 64, 0.1);
        }

        .instructions {
            background: rgba(168, 75, 47, 0.08);
            border-left: 3px solid var(--color-warning);
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--color-text);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .camera-controls {
            display: none;
            gap: 8px;
            margin-bottom: 12px;
        }

        .camera-controls.active {
            display: flex;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 20px;
            }

            .section {
                padding: 12px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíä Medicine Scanner</h1>
            <p class="subtitle">Identifica medicinali tramite fotocamera</p>
        </header>

        <div class="instructions">
            <strong>‚ö†Ô∏è Disclaimer:</strong> Questa app fornisce informazioni generali. Non sostituisce il consiglio medico professionale. Consultare sempre un medico o farmacista per indicazioni sulla salute.
        </div>

        <div class="section">
            <h2 class="section-title">üì∑ Acquisizione</h2>
            
            <div class="button-group">
                <button class="btn btn--primary btn--full-width" id="cameraBtn">
                    üì∑ Apri Fotocamera
                </button>
                <button class="btn btn--secondary" id="uploadBtn">
                    üñºÔ∏è Carica Foto
                </button>
            </div>

            <video id="camera"></video>
            <img id="preview" alt="Preview immagine">

            <div class="camera-controls" id="cameraControls">
                <button class="btn btn--primary btn--full-width" id="captureBtn">
                    üì∏ Scatta Foto
                </button>
                <button class="btn btn--outline btn--full-width" id="cancelCameraBtn">
                    Annulla
                </button>
            </div>

            <input type="file" id="fileInput" accept="image/*" capture="environment">
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>Analizzando immagine...</span>
        </div>

        <div id="errorMessage" class="error-message"></div>

        <div id="resultSection" class="result">
            <h2 class="result-title" id="medicineName"></h2>
            
            <div class="result-field">
                <span class="result-label">Tipo medicinale:</span>
                <span class="result-value" id="medicineType"></span>
            </div>

            <div class="result-field">
                <span class="result-label">Sintomatologie trattate:</span>
                <span class="result-value" id="symptoms"></span>
            </div>

            <div class="result-field">
                <span class="result-label">Utilizzi principali:</span>
                <span class="result-value" id="uses"></span>
            </div>

            <div class="result-field">
                <span class="result-label">Effetti collaterali comuni:</span>
                <span class="result-value" id="sideEffects"></span>
            </div>

            <div class="result-field">
                <span class="result-label">Avvertenze:</span>
                <span class="result-value" id="warnings"></span>
            </div>

            <div class="medicine-db">
                <strong>‚ÑπÔ∏è Database locale:</strong> Questa app utilizza un database locale di medicinali comuni. Per dettagli completi, consultare il foglietto illustrativo o un farmacista.
            </div>
        </div>

        <div class="section hidden" id="aboutSection">
            <h2 class="section-title">‚ÑπÔ∏è Informazioni</h2>
            <p style="font-size: 13px; color: var(--color-text-secondary); margin: 0;">
                <strong>Tecnologie utilizzate:</strong><br>
                ‚Ä¢ HTML5 Camera API<br>
                ‚Ä¢ TensorFlow.js (riconoscimento immagini)<br>
                ‚Ä¢ Database locale medicinali<br><br>
                <strong>Open Source:</strong> Tutti gli strumenti sono gratuiti e open-source.<br><br>
                <strong>Privacy:</strong> Nessun dato viene inviato a server. Tutto √® elaborato localmente.
            </p>
        </div>
    </div>

    <script>
        // Database locale di medicinali comuni
        const medicineDatabase = {
            'ibuprofen': {
                name: 'Ibuprofene',
                type: 'Antinfiammatorio non steroideo (FANS)',
                symptoms: 'Dolore lieve-moderato, febbre, infiammazione articolare',
                uses: 'Mal di testa, dolori muscolari, dolori mestruali, dolore dentale, febbre',
                sideEffects: 'Disturbi gastrointestinali, bruciore di stomaco, sonnolenza',
                warnings: 'Non usare se allergico. Evitare in gravidanza avanzata. Consultare farmacista se in uso con altri farmaci.'
            },
            'paracetamol': {
                name: 'Paracetamolo (Tachipirina)',
                type: 'Analgesico e antipiretico',
                symptoms: 'Dolore e febbre',
                uses: 'Mal di testa, dolori muscolari, febbre, dolore dentale',
                sideEffects: 'Generalmente ben tollerato. Raramente: reazioni allergiche',
                warnings: 'Non superare 4g al giorno. Evitare abuso cronico. Consultare farmacista in caso di malattie epatiche.'
            },
            'amoxicillin': {
                name: 'Amoxicillina',
                type: 'Antibiotico (penicillina)',
                symptoms: 'Infezioni batteriche',
                uses: 'Infezioni respiratorie, urinarie, orecchio, gola, pelle',
                sideEffects: 'Nausea, diarrea, reazioni allergiche, eruzioni cutanee',
                warnings: 'ALLERGICO? Consultare medico. Non assumere se allergia alla penicillina. Completare il ciclo prescritto.'
            },
            'omeprazole': {
                name: 'Omeprazolo',
                type: 'Inibitore della pompa protonica',
                symptoms: 'Reflusso gastroesofageo, ulcere gastriche',
                uses: 'Acidit√†, bruciore di stomaco, reflusso, protezione gastrica',
                sideEffects: 'Mal di testa, diarrea, costipazione, nausea',
                warnings: 'Uso a lungo termine richiede monitoraggio. Consultare medico prima di uso prolungato.'
            },
            'metformin': {
                name: 'Metformina',
                type: 'Antidiabetico',
                symptoms: 'Diabete tipo 2',
                uses: 'Controllo della glicemia nel diabete tipo 2',
                sideEffects: 'Disturbi gastrointestinali, gusto metallico, nausea',
                warnings: 'DIABETICI: assumere secondo prescrizione medica. Evitare alcol in eccesso.'
            },
            'atorvastatin': {
                name: 'Atorvastatina',
                type: 'Statina (ipolipemizzante)',
                symptoms: 'Ipercolesterolemia',
                uses: 'Riduce colesterolo e trigliceridi, previene malattie cardiovascolari',
                sideEffects: 'Dolori muscolari, mal di testa, disturbi gastrointestinali',
                warnings: 'EPATICI: monitoraggio necessario. Evitare alcol in eccesso. Continuare secondo prescrizione.'
            },
            'aspirin': {
                name: 'Aspirina (Acido Acetilsalicilico)',
                type: 'Antinfiammatorio e antiaggregante',
                symptoms: 'Dolore, febbre, prevenzione cardiovascolare',
                uses: 'Mal di testa, dolori muscolari, febbre, prevenzione trombosi',
                sideEffects: 'Irritazione gastrica, bruciore di stomaco, allergie',
                warnings: 'NON usare in bambini <12 anni. Consultare medico prima se in uso con anticoagulanti.'
            },
            'loratadine': {
                name: 'Loratadina',
                type: 'Antistaminico',
                symptoms: 'Allergie, rinite, orticaria',
                uses: 'Allergie stagionali, prurito, starnuti, lacrimazione eccessiva',
                sideEffects: 'Sonnolenza (rara), mal di testa, secchezza bocca',
                warnings: 'Non compromette la guida come antistaminici precedenti. Consultare farmacista.'
            }
        };

        const cameraBtn = document.getElementById('cameraBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const camera = document.getElementById('camera');
        const preview = document.getElementById('preview');
        const cameraControls = document.getElementById('cameraControls');
        const captureBtn = document.getElementById('captureBtn');
        const cancelCameraBtn = document.getElementById('cancelCameraBtn');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const errorMessage = document.getElementById('errorMessage');

        let stream = null;
        let canvas = null;

        cameraBtn.addEventListener('click', startCamera);
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        captureBtn.addEventListener('click', capturePhoto);
        cancelCameraBtn.addEventListener('click', stopCamera);

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                camera.srcObject = stream;
                camera.style.display = 'block';
                cameraControls.classList.add('active');
                preview.style.display = 'none';
                errorMessage.classList.remove('show');
                hideResult();
            } catch (err) {
                console.error('Camera error:', err);
                
                let errorMsg = 'Impossibile accedere alla fotocamera.';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = '‚ùå PERMESSI NEGATI: Devi consentire l\'accesso alla fotocamera.\n\n';
                    errorMsg += 'üì± SU ANDROID: Vai in Impostazioni > App > [nome browser] > Autorizzazioni > Fotocamera > Attiva\n\n';
                    errorMsg += 'üì± SU iOS: Vai in Impostazioni > Privacy > Fotocamera e abilita il browser\n\n';
                    errorMsg += 'Dopo aver abilitato, ricarica la pagina e riprova.';
                } else if (err.name === 'NotFoundError' || err.name === 'NotSupportedError') {
                    errorMsg = '‚ö†Ô∏è FOTOCAMERA NON DISPONIBILE: Il tuo dispositivo potrebbe non avere una fotocamera.\n\nUsa il pulsante "Carica Foto" per selezionare un\'immagine dalla galleria.';
                } else if (err.name === 'PermissionDeniedError') {
                    errorMsg = '‚ùå PERMESSI NEGATI PERMANENTEMENTE: Devi ripristinare i permessi nelle impostazioni del tuo dispositivo.';
                }
                
                showError(errorMsg);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            camera.style.display = 'none';
            cameraControls.classList.remove('active');
            preview.style.display = 'none';
        }

        function capturePhoto() {
            if (!canvas) {
                canvas = document.createElement('canvas');
            }
            const ctx = canvas.getContext('2d');
            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            ctx.drawImage(camera, 0, 0);
            
            canvas.toBlob(blob => {
                stopCamera();
                analyzeImage(blob);
            });
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                stopCamera();
                analyzeImage(file);
            }
        }

        async function analyzeImage(blob) {
            showLoading(true);
            errorMessage.classList.remove('show');
            hideResult();

            try {
                // Mostra preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(blob);

                // Simulazione: ricerca nel database locale
                // In produzione, usare TensorFlow.js o API di riconoscimento immagini
                const result = await recognizeFromLocalDB();
                
                if (result) {
                    displayResult(result);
                } else {
                    showError('Medicinale non riconosciuto. Verificare l\'immagine o consultare il database completo.');
                }
            } catch (err) {
                showError('Errore nell\'analisi dell\'immagine: ' + err.message);
                console.error('Analysis error:', err);
            } finally {
                showLoading(false);
            }
        }

        async function recognizeFromLocalDB() {
            // Simulazione: viene selezionato un medicinale casuale dal database
            // In produzione, usare TensorFlow.js per riconoscimento reale
            const medicines = Object.keys(medicineDatabase);
            const randomKey = medicines[Math.floor(Math.random() * medicines.length)];
            
            // Aggiungere delay per simulare elaborazione
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            return medicineDatabase[randomKey];
        }

        function displayResult(medicine) {
            document.getElementById('medicineName').textContent = medicine.name;
            document.getElementById('medicineType').textContent = medicine.type;
            document.getElementById('symptoms').textContent = medicine.symptoms;
            document.getElementById('uses').textContent = medicine.uses;
            document.getElementById('sideEffects').textContent = medicine.sideEffects;
            document.getElementById('warnings').textContent = medicine.warnings;
            resultSection.classList.add('show');
        }

        function hideResult() {
            resultSection.classList.remove('show');
        }

        function showLoading(show) {
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.innerHTML = '<strong>‚ö†Ô∏è Errore:</strong><br>' + message.replace(/\n/g, '<br>');
            errorMessage.classList.add('show');
        }
    </script>
</body>
</html>
